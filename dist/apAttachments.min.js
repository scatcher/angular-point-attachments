"use strict";angular.module("angularPoint").directive("apAttachments",["$sce","$timeout","toastr","_",function(a,b,c,d){return{restrict:"A",replace:!0,templateUrl:"src/ap_attachments_tmpl.html",scope:{listItem:"=",changeEvent:"=",disabled:"="},link:function(e,f){function g(){var b=e.listItem.getModel(),c=b.list.webURL+"/_layouts/Attachfile.aspx?ListId="+b.list.getListId()+"&ItemId="+e.listItem.id+"&IsDlg=1";return a.trustAsResourceUrl(c)}function h(a){var b=window.confirm("Are you sure you want to delete this file?");b&&(c.info("Negotiating with the server"),e.listItem.deleteAttachment(a).then(function(){c.success("Attachment successfully deleted"),i(),d.isFunction(e.changeEvent)&&e.changeEvent()}))}function i(){var a=e.listItem.getModel();a.getListItemById(e.listItem.id)}function j(a){var b=a.lastIndexOf("/")+1;return a.substr(b)}function k(){e.$$phase||e.$apply()}function l(){d.isFunction(e.changeEvent)&&e.changeEvent(),f.find("iframe").attr("src",f.find("iframe").attr("src"))}if(!e.listItem||!e.listItem.id)throw"A valid list item is required.";e.listItem.attachments=e.listItem.attachments||[],e.deleteAttachment=h,e.fileName=j,e.state={ready:!1},e.trustedUrl=g(),b(function(){f.find("iframe").bind("load",function(){e.state.ready=!0;var a=$(this).contents();a.find("#CancelButton").length<1?(c.success("File successfully uploaded"),l(),i(),d.isFunction(e.changeEvent)&&e.changeEvent()):(a.find("#CancelButton").hide(),a.find(".ms-dialog").css({height:"95px"}),a.find("input[name$='Ok']").css({"float":"left"}).click(function(){c.info("Please wait while the file is uploaded")}),a.find("input[name$='$InputFile']").attr({size:40}),a.find("#s4-workspace").css({"overflow-y":"hidden","overflow-x":"hidden"}),console.log("Frame Loaded"),k())})})}}}]),angular.module("angularPoint").run(["$templateCache",function(a){a.put("src/ap_attachments_tmpl.html",'<div><style>.ap-attachments-container {\n            min-height: 200px;\n        }\n\n        .ap-attachments-container .ap-add-attachments {\n            height: 110px;\n        }\n\n        .ap-attachments-container .ap-add-attachments iframe{\n            height: 95px;\n        }</style><div class=ap-attachments-container><fieldset ng-disabled=disabled><div class="row hidden-print" ng-if=!state.disabled><div class=col-xs-12><div ng-hide=state.ready class="alert alert-info">Loading attachment details</div><div class=ap-add-attachments ng-show=state.ready><h4><small>Add Attachment</small></h4><iframe frameborder=0 seamless width=100% ng-src="{{ trustedUrl }}" scrolling=no></iframe></div></div></div><div ng-if="listItem.attachments.length > 0"><hr class=hr-sm><h4><small>Attachments</small></h4><ul class=list-unstyled><li ng-repeat="attachment in listItem.attachments"><a href="{{ attachment }}" target=_blank>{{ fileName(attachment) }}</a> <button class="btn btn-link" ng-click=deleteAttachment(attachment) title="Delete this attachment"><i class="fa fa-times red"></i></button></li></ul></div></fieldset></div></div>')}]);