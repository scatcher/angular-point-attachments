"use strict";angular.module("angularPoint").directive("apAttachments",["$sce","toastr","_",function(a,b,c){return{restrict:"A",replace:!0,templateUrl:"src/ap_attachments_tmpl.html",scope:{listItem:"=",changeEvent:"=",disabled:"="},link:function(d,e){function f(){c.isFunction(d.changeEvent)&&d.changeEvent(),e.find("iframe").attr("src",e.find("iframe").attr("src"))}d.attachments=[],d.state={ready:!1},d.refresh=function(){d.$$phase||d.$apply()};var g=d.listItem.getModel(),h=g.list.webURL+"/_layouts/Attachfile.aspx?ListId="+g.list.getListId()+"&ItemId="+d.listItem.id+"&IsDlg=1";d.trustedUrl=a.trustAsResourceUrl(h);var i=function(){b.info("Checking for attachments"),d.listItem.getAttachmentCollection().then(function(a){d.attachments.length=0,Array.prototype.push.apply(d.attachments,a)})};i(),d.fileName=function(a){var b=a.lastIndexOf("/")+1;return a.substr(b)},d.deleteAttachment=function(a){var e=window.confirm("Are you sure you want to delete this file?");e&&(b.info("Negotiating with the server"),d.listItem.deleteAttachment(a).then(function(){b.success("Attachment successfully deleted"),i(),c.isFunction(d.changeEvent)&&d.changeEvent()}))},e.find("iframe").bind("load",function(){d.state.ready=!0,d.refresh();var a=$(this).contents();a.find("#CancelButton").length<1?(b.success("File successfully uploaded"),f(),i(),c.isFunction(d.changeEvent)&&d.changeEvent()):(a.find("#CancelButton").hide(),a.find(".ms-dialog").css({height:"95px"}),a.find("input[name$='Ok']").css({"float":"left"}).click(function(){b.info("Please wait while the file is uploaded")}),a.find("input[name$='$InputFile']").attr({size:40}),a.find("#s4-workspace").css({"overflow-y":"hidden","overflow-x":"hidden"}),console.log("Frame Loaded"))})}}}]),angular.module("angularPoint").run(["$templateCache",function(a){a.put("src/ap_attachments_tmpl.html",'<style>.ap-attachments-container {\n        min-height: 200px;\n    }\n\n    .ap-attachments-container .ap-add-attachments {\n        height: 110px;\n    }\n\n    .ap-attachments-container .ap-add-attachments iframe{\n        height: 95px;\n    }</style><div class=ap-attachments-container><fieldset ng-disabled=disabled><div class="row hidden-print"><div class=col-xs-12><div ng-hide=state.ready class="alert alert-info">Loading attachment details</div><div class=ap-add-attachments ng-show=state.ready><h4><small>Add Attachment</small></h4><iframe frameborder=0 seamless width=100% src="{{ trustedUrl }}" scrolling=no></iframe></div></div></div><h4 ng-show="attachments.length > 0"><small>Attachments</small></h4><ul class=list-unstyled><li ng-repeat="attachment in attachments"><a href="{{ attachment }}" target=_blank>{{ fileName(attachment) }}</a> <button class="btn btn-link" ng-click=deleteAttachment(attachment) title="Delete this attachment"><i class="fa fa-times red"></i></button></li></ul></fieldset></div>')}]);