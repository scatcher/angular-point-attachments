"use strict";angular.module("angularPoint").directive("apAttachments",["$sce","$q","$timeout","apDataService","toastr","_",function(a,b,c,d,e,f){return{restrict:"A",replace:!0,templateUrl:"src/ap_attachments_tmpl.html",scope:{listItem:"=",changeEvent:"=",disabled:"="},link:function(g,h){function i(){"undefined"!=typeof FileReader?g.state.legacyBrowser=!1:(g.state.legacyBrowser=!0,n(),g.trustedUrl=j())}function j(){var b=g.listItem.getModel(),c=b.list.webURL+"/_layouts/Attachfile.aspx?ListId="+b.list.getListId()+"&ItemId="+g.listItem.id+"&IsDlg=1";return a.trustAsResourceUrl(c)}function k(a){var b=window.confirm("Are you sure you want to delete this file?");b&&(e.info("Negotiating with the server"),g.listItem.deleteAttachment(a).then(function(){p(),e.success("Attachment successfully deleted"),f.isFunction(g.changeEvent)&&g.changeEvent()}))}function l(a){var b=a.lastIndexOf("/")+1;return a.substr(b)}function m(a){var c=b.defer(),d=new FileReader;return d.onload=function(a){c.resolve(a.target.result)},d.onerror=function(a){c.reject(a.target.error)},d.readAsArrayBuffer(a),c.promise}function n(){r(),h.find("iframe").bind("load",function(){var a=$(this).contents();r(),a.find("#CancelButton").length<1?(e.success("File successfully uploaded"),p(),s(),f.isFunction(g.changeEvent)&&g.changeEvent()):(o(),a.find("#CancelButton").hide(),a.find(".ms-dialog").css({height:"95px"}),a.find("input[name$='Ok']").css({"float":"left"}).click(function(){e.info("Please wait while the file is uploaded")}),a.find("input[name$='$InputFile']").attr({size:40}),a.find("#s4-workspace").css({"overflow-y":"hidden","overflow-x":"hidden"}))})}function o(){var a=10;c(function(){try{var b=h.find("iframe")[0];b.contentWindow.SP.UI.ModalDialog.commonModalDialogClose(function(){a=0})}catch(c){}a--,a>0&&o()},1e3)}function p(){var a=g.listItem.getModel();a.getListItemById(g.listItem.id).then(function(a){g.listItem.attachments!==a.attachments&&(g.listItem.attachments=a.attachments)})}function q(){var a=document.getElementById("ap-file").files[0];a&&t(a.name)&&m(a).then(function(b){for(var c="",f=new Uint8Array(b),h=f.byteLength;h--;)c=String.fromCharCode(f[h])+c;g.state.uploading=!0,d.serviceWrapper({operation:"AddAttachment",listName:g.listItem.getModel().list.getListId(),listItemID:g.listItem.id,fileName:a.name,attachment:btoa(c)}).then(function(){g.state.uploading=!1,e.success("File successfully uploaded"),p()},function(){g.state.uploading=!1,e.error("There was a problem completing the upload.")})})}function r(){g.$$phase||g.$apply()}function s(){f.isFunction(g.changeEvent)&&g.changeEvent(),r(),h.find("iframe").attr("src",j())}function t(a){var b=!0,c="",d=["~","#","%","&","*","{","}","\\","/",":","<",">","?","|",'"',".."];return f.each(d,function(d){return a.indexOf(d)>-1?(c='The "'+d+"\" character isn't allowed to be used in a file name.",b=!1):void 0}),"."===a[a.length-1]&&(c="You cannot use the period character at the end of a file name.",b=!1),"."===a[0]&&(c="You cannot start a file name with the period.",b=!1),b||(c+="  Please update the file on your system and upload again.",e.error(c)),b}g.listItem&&g.listItem.id&&(g.listItem.attachments=g.listItem.attachments||[],g.deleteAttachment=k,g.fileName=l,g.state={legacyBrowser:!1,uploading:!1},g.uploadAttachment=q,i())}}}]),angular.module("angularPoint").run(["$templateCache",function(a){a.put("src/ap_attachments_tmpl.html",'<div><style>.ap-attachments-container {\r\n            min-height: 200px;\r\n        }\r\n\r\n        .ap-attachments-container .ap-add-attachments {\r\n            height: 110px;\r\n        }\r\n\r\n        .ap-attachments-container .ap-add-attachments iframe {\r\n            height: 95px;\r\n        }</style><div class=ap-attachments-container><fieldset ng-disabled=disabled><div ng-if=!state.legacyBrowser><div ng-if=!state.uploading><div class=input-group><input type=file id=ap-file name=file class=form-control> <span class=input-group-btn><button class="btn btn-primary" type=button ng-click=uploadAttachment()>Add</button></span></div><p class=help-block>Select the files you want to upload and then click the Add button.</p></div><div ng-show=state.uploading class="alert alert-info txt-align-center"><i class="fa fa-spinner fa-spin"></i> processing request...</div></div><div class=hidden-print ng-if=state.legacyBrowser><div class=ap-add-attachments><h4><small>Add Attachment</small></h4><iframe frameborder=0 seamless width=100% src="{{ trustedUrl }}" id=ap-attachments-iframe scrolling=no></iframe></div></div><div ng-if="listItem.attachments.length > 0"><hr class=hr-sm><h4><small>Attachments</small></h4><ul class=list-unstyled><li ng-repeat="attachment in listItem.attachments"><a href="{{ attachment }}" target=_blank>{{ fileName(attachment) }}</a> <button type="button" class="btn btn-link" ng-click=deleteAttachment(attachment) title="Delete this attachment"><i class="fa fa-times red"></i></button></li></ul></div></fieldset></div></div>')}]);
